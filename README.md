# Simple IRC Server #
> v. 0.5.2

> 2015-11-12

Основной целью разработки является реализация протокола обмена сообщениями между клиентом и сервером в соответствии со спецификацией RFC2812 с использованием платформы программирования Java SE.

## Содержание ##

  * Использование
  * Файл конфигурации
  * Реализация
  * Ограничения по нагрузке
  * Исходный текст
  * Исполняемый модуль
  * Состав проекта
  * Версии
  * Разработчик

## Использование ##

В качестве исполняемого модуля используется файл sis.jar, находящийся в архиве. Для выполнения программы, необходимо, чтобы на компьютере была развернута среда выполнения программ Java JRE версии не ниже чем v 1.8 и был установлен достаточный объем оперативной памяти. Должно быть зарезервировано место для файла журналирования и файла-протокола клиентских сообщений.

Для выполнения программы необходимо, что бы она имела доступ к файлу конфигурации и для виртуальной машины java был указан ключ -Xms с параметром не меньшим чем 32m.

По умолчанию, программа ищет файл конфигурации с именем `"IrcServerConfig.xml"` в текущем директории, там же будет размещать журнальный файл с именем `"IrcServerLog.xml"` и файл-протокол с именем `"IrcServerTranscript.txt"`.

Информация с заданной степенью детализации о работе программы выводится в журнальный файл.

Запуск программы может производится из командной строки. При запуске, можно использовать следующие ключи:
  * -c - указание файла конфигурации;
  * -h - вывод краткой справки;
  * -l - указание журнального файла;
  * -V - вывод версии программы.

Во время нормального завершения, программа передает операционной системе следующие коды завершения:
  * отсутствие ошибок: 0;
  * обнаружена ошибка в командной строке: 1;
  * неудача запуска компонентов программы или ошибка в файле конфигурации: 2.

В среде Linux запуск может быть произведен следующим образом:

`java -Xms64m -jar sis.jar -c IrcServerConfig.xml -l IrcServerLog.xml &`

В среде MS Windows программу можно запустить вот так:

`javaw -Xms64m -jar sis.jar -c IrcServerConfig.xml -l IrcServerLog.xml`

Приведенные команды запуска можно использовать при небольшом количестве клиентов (до 500 подключений), если количество клиентов может быть больше, то необходимо увеличить объем доступной для java VM памяти с помощью ключа -Xmx. Можно использовать следующие варианты запуска:

Linux:

`java -Xms64m -Xmx1024m -jar sis.jar -c IrcServerConfig.xml -l IrcServerLog.xml &`

MS Windows:

`javaw -Xms64m -Xmx1024m -jar sis.jar -c IrcServerConfig.xml -l IrcServerLog.xml`

#### Формат файла-протокола сообщений клиентов ####

Сообщения клиентов, которые будут переданы на исполнение, сохраняются в файле-протоколе. Каждое сообщение вместе со служебной информацией занимает одну строку. Служебная информация, в виде цепочек символов, размещается в начале строки и разделяется пробелами. Предоставляются следующие данные:
  1. Время регистрации сообщения (UNIX epoch) с точностью до милисекунды в виде целого десятичного числа.
  1. Порядковый номер сообщения в виде целого десятичного числа. Используется сквозная нумерация всех поступающих сообщений.
  1. Сетевой идентификатор отправителя в виде "/IP-адрес:номер сокета".
  1. Никнэйм отправителя.
  1. Либо три тире "---", либо число "424". Символы "---" указывают на то, что сообщение было передано на анализ и исполнение. Число "424" указывает на то, что из-за высокой нагрузки на сервер, сообщение не было обработано и клиенту был передан цифровой ответ ERR\_FILEERROR.

После последнего элемента служебной информациии выводится пробел, затем сообщение клиента.

В сообщениях клиентов, содержащих команду IRC "OPER", параметры команды `<username>` и `<password>` в файл-протокол не выводятся.

Пустые сообщения и сообщения длиной более 510 символов не обрабатываются и не выводятся в файл-протокол.

#### Автоматическая генерация никнэймов ####

При установлении связи, клиенту присваивается уникальный никнэйм, который можно использовать в дальнейших обменах. Он ничем не отличается от обычных никнэймов и его можно заменить с помощью команды IRC "NICK". Этот никнэйм является одним из вариантов семизначного 36-ричного представления порядкового номера клиента. Используется сквозная нумерация клиентов, отсчет ведется от первого подключения после запуска сервера.

#### Функционирование в режиме высокой степени нагрузки на сервер ####

При диагностировании высокой степени нагрузки на сервер или при недостатке доступной памяти, программа прекращает регистрацию вновь подключающихся клиентов и закрывает их сетевые соединения.

При функционирование в этом режиме, клиенты делятся на две категории: операторы и обычные клиенты. Команды операторов продолжают выполняются в соответствии со спецификациями. Набор команд обычных клиентов ограничивается следующими командами: PING; PONG; ADMIN; TIME; OPER. Эти команды исполняются в соответствии со спецификациями, на все остальные команды возвращается цифровой ответ ERR\_FILEERROR `"424 <nickname> :File error doing <command> on SERVER"`, где `<nickname>` - это никнэйм клиента, а `<command>` - это команда IRC.

## Файл конфигурации ##

В этом файле должна быть указана следующая информация о сервере и администраторе сервера:
  * Имя, фамилия и email администратора сервера.
  * Адрес расположения сервера IRC.
  * Наименование и адрес организации, которой принадлежит сервер IRC.
  * Краткая информация о сервере.

В файле конфигурации можно указать следующие параметры IRC сервера:
  * Уровень сохраняемых сообщений журналирующей подсистемы.
  * `TimeZone` сервера.
  * IP - адрес интерфейса, на котором будет открыт порт.
  * Номер порта для входящих соединений.
  * Кодировку сообщений для этого интерфейса.
  * Путь к файлу-протоколу сообщений клиентов.
  * Количество ротаций файлов-протоколов.
  * Максимальная длина файла-протокола клиентских сообщений, по достижению которой производится ротация файлов-протоколов.
  * Пары параметров "логин" "пароль" для операторов IRC.

Для файла конфигурации используется следующая DTD.
```
      <?xml version="1.0" encoding="UTF-8"?>
      <!-- DTD -->
      <!DOCTYPE CONFIG
          [
              <!ELEMENT CONFIG (ADMIN, SERVER?, INTERFACE?, TRANSCRIPT?, 
               OPERATOR*)>
                  <!ELEMENT ADMIN (#PCDATA)>
                  <!ATTLIST ADMIN 
                      name CDATA #REQUIRED 
                      location CDATA #REQUIRED
                      location2 CDATA #REQUIRED
                      email CDATA #REQURED
                      info CDATA #REQURED
                  >
                  <!ELEMENT SERVER (#PCDATA)>
                  <!ATTLIST SERVER
                      debuglevel CDATA 
                      timezone CDATA
                      motd CDATA
                  >
                  <!ELEMENT INTERFACE (#PCDATA)>
                  <!ATTLIST INTERFACE
                     iface CDATA 
                     port CDATA
                     charset CDATA
                  >
                  <!ELEMENT TRANSCRIPT (#PCDATA)>
                  <!ATTLIST TRANSCRIPT 
                      transcript CDATA
                      rotate CDATA
                      length CDATA
                 >
                  <!ELEMENT OPERATOR (#PCDATA)>
                  <!ATTLIST OPERATOR 
                     username CDATA #REQUIRED 
                     password CDATA #REQUIRED
                 >
          ]
      >
```

Ниже приведены описания элементов и атрибутов:
  1. Все атрибуты должны быть строками в кодировке US-ASCII.
  1. Атрибуты элемента "ADMIN":
    * "name", с помощью этого атрибута указываются имя и фамилия администратора сервера;
    * "location", с помощью этого атрибута указывается адрес расположения сервера IRC;
    * "location2", с помощью этого атрибута указывается наименование и адрес организации, которой принадлежит сервер IRC;
    * "email", с помощью этого атрибута указывается адрес электронной почты администратора сервера;
    * "info", с помощью этого атрибута кратко характризуется назначение сервера IRC.
> > В файле конфигурации должны быть определены все атрибуты этого элемента. Их значения используются при выполнении команды IRC "ADMIN".
  1. Атрибуты элемента "SERVER":
    * "debuglevel", с помощью этого атрибута указывается уровень журналируемых сообщений. Эти уровни определены в классе java.util.logging.Level. Допустимо использовать следующие уровни:
      * SEVERE (высший уровень);
      * WARNING;
      * INFO;
      * CONFIG;
      * FINE;
      * FINER;
      * FINEST (низший уровень);
      * OFF - отключение журналирования;
      * ALL - регистрация всех сообщений;
> > с уменьшением уровня увеличивается количество и разнообразие журналируемых сообщений. По умолчанию, используется значение WARNING;
    * timezone", с помощью этого атрибута задается часовой пояс сервера. Допустимые значения определены в классе `java.util.TimeZone`. По умолчанию используется значение "GMT".
    * "motd", с помощью этого атрибута указывается путь к файлу MOTD. По умолчанию будет использован файл `"IrcServerMotd.txt"` в текущем каталоге;
  1. Атрибуты элемента "INTERFACE":
    * "iface", с помощью этого атрибута, в нотации IPv4, задается IP-адрес интерфейса, который будет использован для входящих сетевых подключения. В случае указания пустой строки, сервер будет использовать все доступные сетевые интерфейсы. По умолчанию значение атрибута равно пустой строке;
    * "port", с помощью этого атрибута задается номер порта интерфейса, который будет использован для входящих сетевых подключений. Атрибут должен быть целым десятичным числом в диапазоне 0 - 65535. По умолчанию в качестве номера порта используется номер 6667;
    * "charset", с помощью этого атрибута задается кодировка входящих сообщений. Значения этого атрибута определяется в классе `java.nio.charset.Charset`. Допустимо использовать следующие кодировки:
      * US-ASCII;
      * ISO-8859-1;
      * UTF-8;
      * UTF-16BE;
      * UTF-16LE;
      * UTF-16.
> > по умолчанию в качестве кодировки интерфейса используется кодировка "UTF-8".
  1. Атрибуты элемента "TRANSCRIPT":
    * "transcript", с помощью этого атрибута указывается путь к файлу с протоколом клиентских сообщений. По умолчанию будет использован файл `"IrcServerTranscript.txt"` в текущем каталоге;
    * "rotate", с помощью этого атрибута указывается количество сохраняемых экземпляров файлов-протоколов клиентских сообщений. По умолчанию это количество равно 5;
    * "length", с помощью этого атрибута указывается максимальная длина в байтах файлов-протоколов клиентских сообщений. К числу может быть добавлен суффикс - одна из латинских букв "K" или "M", для задания множителей 1024 и 1048576 соответственно. По умолчанию эта длина ограничена 100K байт.
  1. Атрибуты элемента "OPERATOR": "username" и "password". Значениями этих атрибутов должны быть значения, которые будут использоваться как параметры `<username>` и `<password>` команды IRC "OPER". Максимальное количество этих элементов ограничено 100 единицам.

Ниже приведено примерное содержание файла конфигурации.
```
    <?xml version="1.0" encoding="UTF-8"?>
    <!-- File Name: IrcServerConfig.xml -->
    <CONFIG>
            <ADMIN name="Adminname Adminsurname" 
                location="25, Serverstreet, Servercity, Servercountry" 
                location2="Organizationname, 25, Organizationstreet, Organizationcity, Organizationcountry"  
                email="ircAdmin@dom.ain" 
                info="Experimental IRC server.">
            </ADMIN>
            <SERVER 
                timezone="GMT+0400" 
                debuglevel="WARNING"
                motd="IrcServerMotd.txt">
            </SERVER>
            <INTERFACE  
                port="6667" 
                charset="UTF-8">
            </INTERFACE>
            <TRANSCRIPT 
                transcript="IrcServerTranscript.txt" 
                length="100K" 
                rotate="5">
            </TRANSCRIPT>
            <OPERATOR 
                username="operatorname1" password="operatorpassword1">
            </OPERATOR>
            <OPERATOR 
                username="operatorname2" password="operatorpassword2">
            </OPERATOR>
    </CONFIG>
```


> ## Реализация ##
  1. Реализованные команды (RFC2812): NICK; USER; OPER; MODE; QUIT; JOIN; PART; TOPIC; NAMES; LIST; INVITE; KICK; PRIVMSG; NOTICE; MOTD; LUSERS; VERSION; STATS; LINKS; TIME; ADMIN; INFO; WHO; WHOIS; WHOWAS; KILL; PING; PONG; ERROR; AWAY; REHASH; DIE; RESTART; WALLOPS; USERHOST; ISON.
  1. Команды с ограниченной реализацией: MODE (User mode message и Channel mode message) для вывода параметров ключа, необходимо использовать символ ключа без префикса; STATS - не реализовано вычисление некоторых статистических показателей.
  1. Команды с нереализованным функционалом: PASS; SERVICE; SQUIT; CONNECT; TRACE; SQUERY; SUMMON.
  1. Длина никнэйма ограничена 15 символами.
  1. Длина имени канала ограничена 50 символами.
  1. Поддерживается возможность обмена сообщениями с использованием одной из следующих кодировок: US-ASCII; ISO-8859-1; UTF-8; UTF-16BE; UTF-16LE; UTF-16.
  1. Цифровой ответ "005" используется в варианте ISUPPORT.
  1. Цифровой ответ "424" "ERR\_FILEERROR" дополнен дополнительными вариантами использования.
  1. Не реализована возможность подключение сервисов (RFC2810 2.2.2 Service Clients).
  1. Не реализован межсерверный протокол обмена сообщениями (RFC2813).
  1. Поддерживаются только локальные каналы.
  1. В качестве префиксов каналов допускается использовать только символы "#" и "&".
  1. Сетевые идентификаторы не используются.
  1. Адресация сообщений поддерживается только для никнэймов пользователей и названий каналов. Адресация с помощью сетевых идентификаторов не поддерживается.
  1. Максимальное количество элементов списка для команд с адресаций равно 5.
  1. Отсутствует режим "локальный оператор".
  1. Максимальная допустимая скорость ввода сообщений клиентом - одно сообщение в 2 секунды.
  1. Максимальная средняя скорость передачи сообщений в канал - 10 сообщений в 10 секунд. Эта средняя скорость вычисляется как суммарная средняя скорость передачи сообщений в канал всех членов канала.


## Ограничения по нагрузке ##
  1. Максимальное количество сетевых подключений - 4000.
  1. Максимальное количество каналов - 2000.
  1. Максимальное количество участников обмена сообщениями канала - 1000.
  1. Максимальное количество каналов, к которым может подключится пользователь - 5.
  1. Максимальная средняя скорость ввода сообщений для одного пользователя - 1 сообщение в 2 секунды.
  1. Максимальная средняя скорость передачи сообщений в канал - 10 сообщений в 10 секунд. Эта средняя скорость вычисляется как суммарная средняя скорость передачи сообщений в канал всех членов канала.


## Исходный текст ##

Модули компиляции размещены в различных пакетах так, что бы отражалось их функциональное назначение. В проекте находится файл pom.xml, который используется при сборке с помощью Apache maven (версия не ниже чем 3.0.5).

## Исполняемый модуль ##
Исполняемый модуль по умолчанию располагается в jar-архиве sis.jar.

## Состав проекта ##

  1. GNU Lesser General Public License Version 3, 29 June 2007: lgpl.txt
  2. Исходные тексты
  3. Файл управления сборкой: build.xml
  4. Краткое описание на русском языке: index.ru.html
  5. Краткое описание в формате markdown на русском языке: README.md

## Версии ##

Программа в виде исходных текстов, исполняемого кода и описания распространяется на условиях LGPL v3 .

  * v.0.5.3 от 2015-11-12: Модули компиляции были размещены по пакетам, были добавлены тесты. В качестве инструмента сборки используется Apache maven. С этой версии поддерживается работа в среде Java с версией не ниже чем 1.8.

  * v.0.5.2 от 2015-08-05: Проект был портирован на github.com. Проект размещен по адресу: https://github.com/nkirdin/simple-irc-server
  
  * v.0.5.2 от 2012-03-29: Добавлено указание пути к файлу MOTD в файл конфигурации, изменен выходной текст команды INFO.
Размещение проекта по адресу: http://code.google.com/p/simple-irc-server/

  * v.0.5.1 от 2012-03-20: Размещение архива по адресу: http://sites.google.com/site/workpalace2012/

## Разработчик ##

Николай Кирдин

email: nkirdin@gmail.com

©Nikolay Kirdin, 2012, 2015
